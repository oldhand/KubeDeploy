# alert_rules.yml - Prometheus告警规则配置
# 适用场景：通用服务器、Kubernetes集群基础监控
# 依赖组件：node_exporter（主机指标）、kube-state-metrics（容器/Pod指标）、Prometheus自身指标

# 1. 实例存活监控（基础可用性）
groups:
  - name: instance_availability
    rules:
      - alert: InstanceDown
        # 监控目标宕机（up=0表示Prometheus无法抓取该实例）
        expr: up == 0
        for: 5m  # 持续5分钟未恢复触发告警（过滤短暂网络波动）
        labels:
          severity: critical  # 紧急级别：需立即处理
          category: availability
        annotations:
          summary: "监控实例 {{ $labels.instance }} 宕机"
          description: "{{ $labels.job }} 任务下的 {{ $labels.instance }} 已停止响应超过5分钟（当前状态：不可达）"
          value: "当前值: {{ $value }}"  # $value为0（表示down）


  # 2. 主机资源使用率监控（CPU/内存/磁盘/网络）
  - name: host_resource_usage
    rules:
      # CPU使用率过高
      - alert: HighCPUUsage
        expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance) * 100) > 80
        for: 10m  # 持续10分钟超阈值（避免瞬时峰值）
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "实例 {{ $labels.instance }} CPU使用率过高"
          description: "CPU使用率已超过80%，持续10分钟（当前值：{{ $value | humanizePercentage }}）"
          value: "{{ $value | humanizePercentage }}"

      # 内存使用率过高
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 10m
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "实例 {{ $labels.instance }} 内存使用率过高"
          description: "内存使用率已超过85%，持续10分钟（当前值：{{ $value | humanizePercentage }}）"
          value: "{{ $value | humanizePercentage }}"

      # 根分区磁盘使用率过高
      - alert: HighRootDiskUsage
        expr: 100 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"} * 100) > 85
        for: 15m  # 磁盘告警稍宽松，允许短期波动
        labels:
          severity: warning
          category: resource
        annotations:
          summary: "实例 {{ $labels.instance }} 根分区磁盘使用率过高"
          description: "根分区使用率已超过85%，持续15分钟（当前值：{{ $value | humanizePercentage }}）"
          value: "{{ $value | humanizePercentage }}"

      # 根分区剩余空间不足（紧急）
      - alert: LowRootDiskSpace
        expr: node_filesystem_avail_bytes{mountpoint="/"} < 10 * 1024 * 1024 * 1024  # 10GB
        for: 5m
        labels:
          severity: critical
          category: resource
        annotations:
          summary: "实例 {{ $labels.instance }} 根分区剩余空间不足"
          description: "根分区剩余空间已低于10GB，持续5分钟（当前值：{{ $value | humanizeBytes }}）"
          value: "{{ $value | humanizeBytes }}"

      # 网络流量过高（入站+出站）
      - alert: HighNetworkTraffic
        expr: sum(irate(node_network_transmit_bytes_total[5m]) + irate(node_network_receive_bytes_total[5m])) by (instance) > 100 * 1024 * 1024  # 100MB/s
        for: 5m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "实例 {{ $labels.instance }} 网络流量过高"
          description: "总网络流量（入站+出站）已超过100MB/s，持续5分钟（当前值：{{ $value | humanizeBytes }}/s）"
          value: "{{ $value | humanizeBytes }}/s"


  # 3. Kubernetes容器/Pod监控（需部署kube-state-metrics）
  - name: k8s_container_pod
    rules:
      # Pod频繁重启
      - alert: PodFrequentRestart
        expr: increase(kube_pod_container_status_restarts_total[10m]) by (pod, namespace) > 3
        for: 1m
        labels:
          severity: warning
          category: k8s
        annotations:
          summary: "命名空间 {{ $labels.namespace }} 中Pod {{ $labels.pod }} 频繁重启"
          description: "10分钟内重启次数超过3次（当前值：{{ $value }}次），可能存在程序异常"
          value: "{{ $value }}次"

      # 容器状态异常（非Running状态）
      - alert: ContainerNotRunning
        expr: kube_pod_container_status_running != 1
        for: 3m
        labels:
          severity: critical
          category: k8s
        annotations:
          summary: "命名空间 {{ $labels.namespace }} 中Pod {{ $labels.pod }} 的容器 {{ $labels.container }} 未运行"
          description: "容器状态异常（非Running），持续3分钟，可能影响服务可用性"


  # 4. 监控系统自身健康度（Prometheus/Alertmanager）
  - name: monitoring_system_health
    rules:
      # Prometheus告警规则评估失败
      - alert: PrometheusRuleEvaluationFailed
        expr: prometheus_rule_evaluation_failures_total > 0
        for: 1m
        labels:
          severity: critical
          category: monitoring
        annotations:
          summary: "Prometheus 告警规则评估失败"
          description: "存在 {{ $value }} 条规则评估失败，请检查规则语法或指标是否存在"
          value: "{{ $value }}条"

      # Prometheus存储容量不足
      - alert: PrometheusStorageLow
        expr: prometheus_tsdb_storage_blocks_bytes / prometheus_tsdb_storage_retention_bytes * 100 > 80
        for: 10m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Prometheus 存储容量不足"
          description: "存储已使用超过80%（当前值：{{ $value | humanizePercentage }}），建议扩展存储或缩短保留时间"
          value: "{{ $value | humanizePercentage }}"

      # Alertmanager不可用
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 3m
        labels:
          severity: critical
          category: monitoring
        annotations:
          summary: "Alertmanager 实例 {{ $labels.instance }} 不可用"
          description: "Alertmanager已停止响应超过3分钟，告警通知可能无法正常发送"
